{"version":3,"sources":["../../src/modules/mail.js"],"names":["helper","require","mail","module","exports","sendMail","email","subject","text","from","html","automatic","Promise","resolve","reject","domain_name","replace","name","unique_id","Math","random","toString","substr","tracking_id","base_track_url","Instance","data","dataValues","mailer","createTransport","host","smtp_server","port","parseInt","server_port","auth","user","username","pass","password","to","template","replyTo","error","response","message","status","email_response","body","reply_to","close","sendUsingSendGrid","to_emails","sg","SMTP_PASS","request","emptyRequest","method","path","personalizations","send_at","floor","Date","getTime","content","type","value","API","console","log","sendScheduledMail","cc","app_hr_contact_email","bcc","admin_mail"],"mappings":"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","file":"mail.js","sourcesContent":["import nodemailer from \"nodemailer\";\nimport smtpTransport from \"nodemailer-smtp-transport\";\nimport config from \"../config\";\nimport emailExistence from \"email-existence\";\nimport constant from \"../models/constant\";\nimport moment from \"moment\";\nlet helper = require('sendgrid').mail;\nimport uuid from 'uuid';\n\nmodule.exports = {\n    sendMail: function(email, subject, text, from, html, automatic) {\n        return new Promise((resolve, reject) => {\n            // html += constant().add_html_suffix_email_tracking + \"&tid=\" + (process.env.TRACKING_ID || config.TRACKING_ID) + \"&cid=\" + (process.env.CLIENT_ID || config.CLIENT_ID) + \"&t=event&ec=\" + subject + \"_  \" + moment().format(\"YYYY-MM-DD\") + \"&ea=open&el=\" + email + \"\\\"/>\";\n            let domain_name = from.email.replace(/.*@/, \"\");\n            let name = from.email.replace(/@[^@]+$/, '');\n            let unique_id = name + `+${Math.random().toString(36).substr(2, 9)}@` + domain_name;\n            let tracking_id = email + Math.random().toString(36).substr(2, 9)\n\n            html += `<img src=\"${constant().base_track_url}/${email}/${tracking_id}\">`\n            if (!from.email)\n                from = (from.Instance || from.data) ? from.Instance.dataValues : from.dataValues;\n            let mailer = nodemailer.createTransport(smtpTransport({\n                host: from.smtp_server,\n                port: parseInt(from.server_port),\n                auth: {\n                    user: from.username,\n                    pass: from.password\n                }\n            }));\n\n            mailer.sendMail({\n                from: from.email,\n                to: email,\n                subject: subject,\n                template: text || \"\",\n                html: html,\n                replyTo: automatic ? unique_id : from.email\n            }, (error, response) => {\n                if (error) {\n                    reject(\"Invalid Smtp Information\");\n                } else {\n                    resolve({ message: \"messsage send successfully\", status: 1, email_response: response, subject: subject, body: html, reply_to: unique_id, tracking_id: tracking_id });\n                }\n                mailer.close();\n            });\n        })\n    },\n\n    sendUsingSendGrid: function(to_emails, subject, html, from, body) {\n        return new Promise((resolve, reject) => {\n            let sg = require('sendgrid')(config.SMTP_PASS);\n            let request = sg.emptyRequest({\n                method: 'POST',\n                path: '/v3/mail/send',\n                body: {\n                    personalizations: [{\n                        to: to_emails,\n                        subject: subject\n                    }],\n                    send_at: Math.floor((new Date().getTime() / 1000) + 60),\n                    from: {\n                        email: from\n                    },\n                    content: [{\n                        type: 'text/plain',\n                        value: body\n                    }],\n                }\n            });\n\n            sg.API(request, function(error, response) {\n                if (error) {\n                    console.log('Error response received');\n                }\n                resolve({ message: \"messsage send successfully\", status: 1 });\n            });\n        })\n    },\n\n    sendScheduledMail: function(email, subject, text, from, html) {\n        return new Promise((resolve, reject) => {\n            // html += constant().add_html_suffix_email_tracking + \"&tid=\" + process.env.TRACKING_ID || config.TRACKING_ID + \"&cid=\" + process.env.CLIENT_ID || config.CLIENT_ID + \"&t=event&ec=\" + subject + \"_  \" + moment().format(\"YYYY-MM-DD\") + \"&ea=open&el=\" + email + \"\\\"/>\";\n            console.log(html)\n            if (!from.email)\n                from = (from.Instance || from.data) ? from.Instance.dataValues : from.dataValues;\n            let mailer = nodemailer.createTransport(smtpTransport({\n                host: from.smtp_server,\n                port: parseInt(from.server_port),\n                auth: {\n                    user: from.username,\n                    pass: from.password\n                }\n            }));\n            mailer.sendMail({\n                from: from.email,\n                to: email,\n                subject: subject,\n                template: text || \"\",\n                html: html,\n                cc: constant().app_hr_contact_email,\n                bcc: constant().admin_mail\n            }, (error, response) => {\n                if (error) {\n                    reject(\"Invalid Smtp Information\");\n                } else {\n                    resolve({ message: \"messsage send successfully\", status: 1, email_response: response, subject: subject, body: html });\n                }\n                mailer.close();\n            });\n        })\n    }\n};"]}